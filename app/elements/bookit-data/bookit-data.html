<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="bookit-data">
	<template>
		<iron-ajax
			id="bookitAjax"
			url="http://mapit-proxy.cy.id.au/api.py"
			params='{{params}}'
			handle-as="json"
			last-response="{{sites}}"
			last-error="{{bookitError}}">
		</iron-ajax>
	</template>

	<script>
		Polymer({
			is: 'bookit-data',

			properties: {
				sites: {
					type: Object,
					notify: true,
					value: [],
					observer: '_sitesChanged'
				},

				site: {
					type: String,
					notify: true,
					value: '',
					observer: '_siteChanged'
				},

				isLoading: {
					type: Boolean,
					value: true,
					notify: true
				},

				siteID: {
					type: String,
					computed: 'getSiteID(site)'
				},

				params: {
					type: Object,
					value: {name: ''}
				},

				refresh: {
					type: Boolean,
					value: false,
					notify: true,
					observer: '_refreshChanged'

				}
			},

			_refreshChanged: function(refresh) {
				if (refresh) {
					console.log('Refreshing site ' + this.site);
					this.$.bookitAjax.generateRequest();
					this.refresh = false;
				}
			},

			_siteChanged: function(site) {
				console.log('Setting site to ' + site);
				this.sites = [];
				this.params = {
					'url': 'https://bookit.unimelb.edu.au/MyPC/Front.aspx?page=getResourceStatesAPI&siteId=' + this.getSiteID(this.site),
				};

				this.$.bookitAjax.generateRequest();
			},

			_sitesChanged: function(newSites) {
				if (newSites === null || newSites.length === 0) {
					this.isLoading = true;
				} else {
					this.isLoading = false;
				}

				// Delete the first element of the array which is the _default site.
				// We do not care about it.
				if (this.sites && this.sites.length > 0 && this.sites[0].name === '_default') {
					this.sites.splice(0,1);
				}
			},

			getSiteID: function(site) {
				var ids = {
					'architecture':  8,
					'baillieu':      2,
					'brownless':    11,
					'erc':           7,
					'giblin_eunson': 3,
					'law':          12,
					'lenton_parr':   9,
					'':             ''
				};

				return ids[site];
			}
		});
	</script>
</dom-module>
