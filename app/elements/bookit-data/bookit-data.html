<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="bookit-data">
	<template>
		<iron-ajax
			id="bookitAjax"
			url="http://mapit-proxy.cy.id.au/api.py"
			params='{{_params}}'
			handle-as="json"
			last-response="{{data}}">
		</iron-ajax>
	</template>

	<script>
		Polymer({
			is: 'bookit-data',

			properties: {
				/* List of bookit sites/locations/resources returned
				 * by the API call. */
				data: {
					type: Object,
					notify: true,
					value: [],
					observer: '_dataChanged'
				},

				/* Is the API request currently in flight */
				isLoading: {
					type: Boolean,
					value: true,
					notify: true
				},

				/* Doesn't seem to be a way to do a function all for this, so use a boolean! Set refresh to true
				 * to trigger a data refresh. After the refresh has been triggered it reverts to false. */
				refresh: {
					type: Boolean,
					value: false,
					notify: true,
					observer: '_refreshChanged'
				},

				/* Can't pass the URL directly to iron ajax due to CORS issues. The workaround is proxying the API
				 * and enabling CORS that way, and that's set up to get the data by passing in the URL */
				_params: {
					type: Object,
					value: {'url': 'https://bookit.unimelb.edu.au/MyPC/Front.aspx?page=getResourceStatesAPI'}
				}
			},

			attached: function() {
				this._doRequest();
			},

			_refreshChanged: function(refresh) {
				if (refresh) {
					this._doRequest();
					this.refresh = false;
				}
			},

			_dataChanged: function() {
				this.isLoading = false;

				console.log('data changed');

				console.log(this.data);

				// Delete the first element of the array which is the _default site.
				// We do not care about it.
				if (this.data && this.data.length > 0 && this.data[0].name === '_default') {
					this.data.splice(0,1);
				}
			},

			/********************
			 * Custom Functions *
			 ********************/
			_doRequest: function() {
				// Check for requests in progress, don't want to spam the server
				// with multiple requests
				if (!this.isLoading) {
					this.$.bookitAjax.generateRequest();
					this.isLoading = true;
				} else {
					console.log('Already waiting for a data request. Ignoring refresh request');
				}
			}
		});
	</script>
</dom-module>
