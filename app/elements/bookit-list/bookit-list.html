<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="bookit-list">
	<link rel="import" type="css" href="bookit-list.css">

	<template>
		<div id="loading" hidden$="{{!isLoading}}">
			<paper-spinner alt="Loading resource list" active></paper-spinner>
		</div>
		<div id="content" hidden$="{{isLoading}}">
		<list-dropdown></list-dropdown>
		<template is="dom-repeat" items="[[sites]]" as="site">
			<template is="dom-repeat" items="[[site.locations]]" as="location">
				<div class="list" role="list">
       					<list-header name="[[location.name]]" free="{{freeResources(location.resources)}}"
					             total="[[totalResources(location.resources)]]"></list-header>
					<paper-menu class="list" on-iron-activate="_listTap">
						<template is="dom-repeat" items="[[location.resources]]" as="resource">
							<paper-item class="draggable" draggable="true" on-dragstart="_handleDragStart">
								<div class$="{{iconColour(resource.state)}}" item-icon></div>
								<div class="item_name">[[resource.name]]</div>
							</paper-item>
						</template>
					</paper-menu>
				</div>
			</template>
		</template>
		</div>
	</template>

	<script>
		Polymer({
			is: 'bookit-list',

			properties: {
				sites: {
					type: Object,
					value: []
				},

				isLoading: {
					type: Boolean,
					value: true 
				},

				resource: {
					type: String,
					notify: true
				}
			},

			_listTap: function(e,detail) {
				console.log(detail.item.innerText);
				this.fire('closeDrawer');
				this.resource = '';
				this.resource = detail.item.innerText;
			},

			_handleDragStart: function(e, detail) {
				console.log('Dragstart');
				console.log(e);
				console.log(detail);
				var name = e.target.innerText;
				e.dataTransfer.setData('text/html', name);
			},

			freeResources: function(resources) {
				var free = 0;

				for (var i in resources) {
					var resource = resources[i];

					if (resource.state === 'AVAILABLE') {
						free += 1;
					}
				}

				return free;
			},

			totalResources: function(resources) {
				return resources.length;
			},

			iconColour: function(state) {
				if (state === 'AVAILABLE') {
					return 'avatar green';
				} else if (state === 'NOT_AVAILABLE') {
					return 'avatar black';
				} else if (state === 'RESERVED') {
					return 'avatar yellow';
				} else if (state === 'IN_USE') {
					return 'avatar red';
				}

				return 'avatar blue';
			}
		});
	</script>
</dom-module>
