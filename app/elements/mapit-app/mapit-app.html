<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<link rel="import" href="../routing.html">

<link rel="import" href="../all-summary/all-summary.html">
<link rel="import" href="../bookit-data/bookit-data.html">
<link rel="import" href="../bookit-list/bookit-list.html">
<link rel="import" href="../bookit-map/bookit-map.html">

<dom-module id="mapit-app">
	<link rel="import" type="css" href="mapit-app.css">

	<template>
		<bookit-data id="bookit_data" site="{{site}}" sites="{{sites}}" is-loading="{{isLoading}}" refresh="{{refresh}}"></bookit-data>

		<paper-drawer-panel id="navDrawerPanel" responsive-width="1280px" on-transitionend="_onDrawerAnimationFinish">
			<div class="nav" drawer>
				<paper-toolbar id="drawerToolbar">
					<span class="paper-font-title">Menu</span>
				</paper-toolbar>

				<site-list></site-list>
			</div>

			<div main>
				<div id="wrapper" style="display: flex; flex-direction: column; height: 100%;">
				<paper-toolbar id="pageToolbar" class="mainToolbar">
					<paper-icon-button id="menu_btn" icon="menu" hidden="[[!_showMenuBtn]]" paper-drawer-toggle></paper-icon-button>
					<paper-icon-button id="back_arrow" icon="arrow-back"
					                   on-tap="_handleBackPress" hidden="{{hideBackArrow()}}"></paper-icon-button>

					<span class="title">MapIT</span>
						<paper-icon-button icon="refresh" on-tap="_tapRefresh"></paper-icon-button>
						<paper-icon-button icon="search"></paper-icon-button>
          			</paper-toolbar>
			<iron-pages id="iPages" attr-for-selected="data-section" selected="0">
				<section data-section="summary">
					<all-summary id="allLibSum" sites="[[sites]]" is-loading="[[isLoading]]"></all-summary>
				</section>

				<section data-section="library">
					<paper-drawer-panel id="mainDrawerPanel" class="main-drawer-panel" responsive-width="600px"
					                    drawer-width="[[_computeListWidth(_isMobile)]]" drawer-toggle-attribute="list-toggle"
					                    narrow="{{_isMobile}}" default-selected="drawer" disable-swipe
					                    on-iron-select="_onMainDrawerSelect">
        					<paper-header-panel class="list-panel" drawer>
							<div class="fit">
								<bookit-list sites="[[sites]]" resource="{{resource}}" is-loading="[[isLoading]]"></bookit-list>
							</div>

						</paper-header-panel>

						<paper-header-panel class="content-panel" main>
							<div class="fit">
								<bookit-map site="{{site}}" focus-resource="[[resource]]" resources="[[sites]]"></bookit-map>
							</div>

						</paper-header-panel>
					</paper-drawer-panel>
				</section>
			</iron-pages>
			</div>
			</div>
		</paper-drawer-panel>

		<iron-media-query query="(max-width: 1280px)" query-matches="{{_showMenuBtn}}"></iron-media-query>
	</template>

	<script>
		(function() {
                        'use strict';

			Polymer({
				is: 'mapit-app',

				properties: {
					drawerOpen: {
						type: Boolean,
						value: false
					}
				},
				behaviors: [
					Polymer.IronResizableBehavior
				],
				listeners: {
					'iron-resize': 'resize'
				},

				attached: function() {
					document.querySelector('bookit-list').addEventListener('closeDrawer', function () {
						document.getElementById('mainDrawerPanel').closeDrawer();
					});

					document.querySelector('site-list').addEventListener('tap-item', function() {
						document.getElementById('navDrawerPanel').closeDrawer();
					});

					this.resize();
				},

				resize: function() {
					var toolbarHeight = this.$.pageToolbar.clientHeight;
					document.getElementById('allLibSum').style.height = (window.innerHeight - toolbarHeight) + 'px';
					document.getElementById('mainDrawerPanel').style.height = (window.innerHeight - toolbarHeight) + 'px';
				},

				_onDrawerAnimationFinish: function() {
					// Set the property which tells us whether the drawer is open or not
					// since the drawer doesn't give us that information for some reason.
					// TODO: Modify drawer and upstream changes.
					var selected = document.querySelector('#navDrawerPanel').selected;
					this.drawerOpen = (selected === 'drawer');

					// The variable _site is set if there's a site change queued up
					// waiting for the drawer animation to finish, and now it has!
					if (this._site !== '') {
						// set the actual site value and then reset the temporary one
						// so that we don't repetitively set the site and thus spam
						// network requests.
						var bookit = document.querySelector('#bookit_data');
						bookit.site = this._site;
						this._site = '';
					}
				},

				_computeListWidth: function(isMobile) {
					// when in mobile screen size, make the list be 100% width to cover the whole screen
					return isMobile ? '100%' : '360px';
				},

				_handleBackPress: function() {
					console.log('o.o');
					document.getElementById('mainDrawerPanel').openDrawer();
				},

				_onMainDrawerSelect: function(e, detail) {
					var drawerNarrow = document.getElementById('mainDrawerPanel').narrow;
					var librarySelected = document.getElementById('iPages').selected === 'library';

					if (detail.item.id === 'main' || detail.item.id === 'drawer') {
						var hidden = !(detail.item.id === 'main' && drawerNarrow && librarySelected);
						document.getElementById('back_arrow').hidden = hidden;

						if (hidden) {
							document.getElementById('menu_btn').style.display = 'block';
						} else {
							document.getElementById('menu_btn').style.display = 'none';
						}
					}
				},

				_tapRefresh: function() {
					console.log('tap tap');
					this.refresh = true;
				},

				hideBackArrow: function() {
					if (document.getElementById('mainDrawerPanel').narrow &&
					    document.getElementById('iPages').selected === 'library') {
						document.getElementById('menu_btn').style.display = 'none';
						return false;
					}
					document.getElementById('menu_btn').style.display = 'block';
					return true;
				}
			});
		})();
	</script>
</dom-module>
