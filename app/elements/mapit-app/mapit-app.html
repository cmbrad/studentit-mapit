<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<link rel="import" href="../routing.html">

<link rel="import" href="../all-summary/all-summary.html">
<link rel="import" href="../site-explore/site-explore.html">
<link rel="import" href="../bookit-data/bookit-data.html">
<link rel="import" href="../bookit-list/bookit-list.html">
<link rel="import" href="../bookit-map/bookit-map.html">

<dom-module id="mapit-app">
	<link rel="import" type="css" href="mapit-app.css">

	<template>
		<bookit-data id="bookit_data" site="{{site}}" sites="{{sites}}" is-loading="{{isLoading}}"
		             refresh="{{refresh}}" response-at="{{responseAt}}"></bookit-data>

		<paper-drawer-panel id="navDrawerPanel" responsive-width="1280px" on-transitionend="_onDrawerAnimationFinish">
			<div class="nav" drawer>
				<paper-toolbar id="drawerToolbar"></paper-toolbar>
				<site-list></site-list>
			</div>

			<div main>
				<div id="wrapper" style="display: flex; flex-direction: column; height: 100%;">
				<paper-toolbar id="pageToolbar" class="mainToolbar">
					<paper-icon-button id="menu_btn" icon="menu" hidden="[[!_showMenuBtn]]" paper-drawer-toggle></paper-icon-button>

					<span class="title">MapIT</span>
					<paper-icon-button icon="refresh" on-tap="_tapRefresh"></paper-icon-button>
					<paper-icon-button icon="search"></paper-icon-button>
          			</paper-toolbar>

			<iron-pages id="iPages" attr-for-selected="data-section" selected="0">
				<all-summary  data-section="summary" sites="[[sites]]" id="allLibSum" is-loading="[[isLoading]]"></all-summary>
				<site-explore data-section="library" site="[[site]]" sites="[[sites]]" is-loading="[[isLoading]]"></site-explorer>
			</iron-pages>
			</div>
			</div>
		</paper-drawer-panel>
		
		<paper-toast id="routeToast"></paper-toast>
		<paper-toast id="refreshToast" text="Refreshed data.">

		<iron-media-query query="(max-width: 1280px)" query-matches="{{_showMenuBtn}}"></iron-media-query>
	</template>

	<script>
		(function() {
                        'use strict';

			Polymer({
				is: 'mapit-app',

				properties: {
					drawerOpen: {
						type: Boolean,
						value: false
					},
					responseAt: {
						type: String,
						observer: 'responseAtChanged'
					},

					_site: {
						type: String,
						value: null
					},
					_selected: {
						type: String,
						value: null
					}
				},
				behaviors: [
					Polymer.IronResizableBehavior
				],
				listeners: {
					'iron-resize': 'resize'
				},

				responseAtChanged: function() {
					this.$.refreshToast.show();
				},

				attached: function() {
					this.resize();

					var that = this;
					setInterval(function() {
						that.refresh = true;
					}, 60000);

					document.querySelector('site-list').addEventListener('tap-item', function() {
						that.$.navDrawerPanel.closeDrawer();
					});
				},

				resize: function() {
					var toolbarHeight = this.$.pageToolbar.clientHeight;
					document.getElementById('allLibSum').style.height = (window.innerHeight - toolbarHeight) + 'px';
				},

				_onDrawerAnimationFinish: function(e) {
					// Set the property which tells us whether the drawer is open or not
					// since the drawer doesn't give us that information for some reason.
					// TODO: Modify drawer and upstream changes.
					// Must do this check as sometimes a paper ripple transition ends
					// before the drawer close press is registered which interefers with
					// with this code and makes the drawer seem closed. This causes animation
					// lag as the UI tries to change as its' still animating
					if (e.target.tagName === 'DIV') {
						var selected = document.querySelector('#navDrawerPanel').selected;
						this.drawerOpen = (selected === 'drawer');
					}

					// The variable _site is set if there's a site change queued up
					// waiting for the drawer animation to finish, and now it has!
					if (this._site !== null) {
						// set the actual site value and then reset the temporary one
						// so that we don't repetitively set the site and thus spam
						// network requests.
						var bookit = document.querySelector('#bookit_data');
						bookit.site = this._site;
						var iPages = document.querySelector('#iPages');
						iPages.selected = this._selected;
						this._selected = null;
						this._site = null;
						this.drawerOpen = false;
					}
				},

				_computeListWidth: function(isMobile) {
					// when in mobile screen size, make the list be 100% width to cover the whole screen
					return isMobile ? '100%' : '360px';
				},

				_onMainDrawerSelect: function(e, detail) {
					var librarySelected = document.getElementById('iPages').selected === 'library';

					if (detail.item.id === 'main' || detail.item.id === 'drawer') {
						var hidden = !(detail.item.id === 'main' && librarySelected);
						document.getElementById('back_arrow').hidden = hidden;

						if (hidden) {
							document.getElementById('menu_btn').style.display = 'block';
						} else {
							document.getElementById('menu_btn').style.display = 'none';
						}
					}
				},

				_tapRefresh: function() {
					this.refresh = true;
				}
			});
		})();
	</script>
</dom-module>
